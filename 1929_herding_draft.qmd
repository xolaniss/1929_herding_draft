---
format:
  pdf:
    tbl-cap-location: top
    dpi: 500
    fig-pos: "H"
    number-sections: true
    cite-method: natbib
    include-in-header: preamble.tex
    include-before-body: title.tex
pdf-engine: xelatex
monofont: "DejaVu Sans Mono"
mainfont: "Times New Roman"
execute: 
  echo: false
  warning: false
editor: source
bibliography: references.bib
biblio-style: apalike
natbiboptions: round
link-citations: true
linkcolor: blue!000!black
urlcolor: blue!000!black
citecolor: blue!000!black
linestretch: 1.5
indent: TRUE
---

```{r}
#| label: setup
#| include: false
options(scipen=999)
knitr::opts_chunk$set(
                      fig.pos = "H", 
                      fig.env= 'figure', 
                      ft.align = "left",
                      ft.tabcolsep= 0, 
                      ft.latex.float = "none",
                      ft.arraystretch = 0.3
                      )
library(tidyverse)
library(readr)
library(readxl)
library(zoo)
library(magick)
library(stringi)
library(patchwork)
library(xtable)
library(scales)
library(rvest)
library(rebus)
library(PNWColors)
library(lubridate)
library(here)
library(flextable)
library(gt)
library(officer)
library(officedown)
library(modelsummary)
library(sandwich)
library(lmtest)
library(stargazer)
```

```{r}
#| label: func
source(here("Functions","flextable_word.R" ))
source(here("Functions","modelsummary_pdf.R" ))
source(here("Functions","borderlines.R" ))

set_flextable_defaults(font.size = 7, 
                       text.align = "left", 
                       font.color = "black", 
                       theme_fun = theme_apa, 
                       padding = 0,
                       line_spacing = 0)
```

# Introduction

@duygun2021


# Literature Review

#  Data and Methodology
## Data
The analysis utilises Kenneth French's 49 industry portfolio returns^[\url{http://mba.tuck.dartmouth.edu/pages/faculty/ken.french}]. Through his website Kenneth French provides a variety of financial market related data for research purposes, which include the famous Fama/French factors data. These data have two main advantages for researchers. First, the industry portfolio data varies in detail from 5 industry to 49 industry data-sets. Second, the data cover long periods of time, typically to pre World War II. Specifically, the daily data covers the period 1 July 1926 to ends in 29 July 2022. The significant length and breadth of this data is essential for our analysis.   

We create 5 industry groups from the 49 industries in order to calculate the cross sectional dispersions as outlined in the methodology. In the data, stocks are assigned^[At the end of June each year] from the NYSE, AMEX, NASDAQ to an industry portfolio using a four-digit Centre for Research in Security Prices Standard Industry Classification Codes (CSRP-SIC). Essentially, the CSRP-SICs determine the level of industry aggregation in the data. Therefore, in @tbl-grouping we group the industries using the CSRP-SICs^[These are also available from \url{http://mba.tuck.dartmouth.edu/pages/faculty/ken.french}]. Lastly, @fig-cons to @fig-mines, and @tbl-data_descriptives show the described industry data. 

## Methodology
Empirically herding is defined in line with @chang2000examination. Herding is measured by first calculating returns:

$$ R_{t} = \left(\dfrac{E_t}{E_{t-1}} - 1\right) \times 100,$$


where $R_{t}$ is a return at time $t$, $E_t$ and $E_{t-1}$ is index value at time $t$ and $t-1$. Returns form the foundation of the analysis as they contain all information on the market, including shocks and investor sentiment. 

Following @christie1995following and @chang2000examination we calculate two dispersion metrics. The cross-sectional standards deviation ($CSSD_{t}$) and the cross-sectional absolute standard deviations ($CSAD_{t}$). **add** The dispersion measures are calculated for all markets as follows:

$$CSSD_{t} = \sqrt{\sum_{i = 1}^{N}w_{i,t}(R_{i,t} - R_{m, t})^2},$$

$$CSAD_{t} = \sum_{i =1}^{N}w_{i,t}{|R_{i,t} - R_{m,t}|},$$

where $R_{i,t}$ observed currency returns from market $i$ at time $t$, $R_{m,t}$ is a trade weighted average of the $R_{i,t}$ or the market return, $w_{i,t}$ is the respective trade weight of each market over time with the South Africa, and the $\sum_{i}w_{i,t}= 1$. The return dispersion measures capture the directional similarity across currency returns at a given point in time with respect to the aggregate market. Herding tests, in turn, are based on the pattern of return dispersions during periods of large price movements. Usually, the return dispersion metrics tend to be positively associated with market returns in the absence of herding. 

Next, the pattern of return dispersions during periods of large price movements is examined. The rationale behind the testing methodology is that, if herding is present, the correlated trades by investors will lead to greater directional similarity in currency returns, thus leading to lower dispersion in returns. This can be measured by the sign of the coefficients of the relationship between the return dispersion and $R_{m, t}$ and $R_{m, t}^2$ (or market return measures) in these equations for the general market herding:

$$CSSD_{t} = \alpha_0 +  \alpha_1|R_{m, t}| +  \alpha_2R_{m, t}^2 + \epsilon_{t},$$
$$CSAD_{t} =  \alpha_0 +  \alpha_1|R_{m, t}| +  \alpha_2R_{m, t}^2 + \epsilon_{t},$$

where $\alpha_2$ is the herding coefficient. The expectation is that $\alpha_1 > 0$ and $\alpha_2=0$, indicating the absence of herding. However, herding would be implied by $\alpha_2 < 0$, which indicates that return dispersions are significantly lower during market stress due to correlated trading behaviour, leading to greater directional similarity in returns. Likewise, $\alpha_2 > 0$ would indicate anti-herding, indicating that traders go against the market consensus [@stavroyiannis2015time]. The purpose of the $CSSD_t$ and the $CSAD_t$ regressions is not to determine the best fit but to test the directional similarity of returns. This is possible because returns data are typically highly correlated and stationary. To ensure that the results are not spurious, all the $CSSD_t$ and the $CSAD_t$ regressions in this study use Heteroskedasticity and Autocorrelation Consistent (HAC) standard errors as defined by @zeileis2004econometric. 

# Results

## Descriptive analysis

\newpage

```{r}
#| label: fig-results-all
#| fig-cap: "Cross sectional deviations"
#| fig-height: 14
#| fig-width: 10
#| cache: true
cross_sectionals <- read_rds(here("Outputs", "artifacts_csad_cssd.rds"))
results_all_crisis_gg <- cross_sectionals$graphs$results_all_crisis_gg
results_all_crisis_gg
```


\newpage

```{r}
#| label: tbl-desc
#| tbl-cap: "Descriptive statistics"
#| cache: false

descriptives <- read_rds(here("Outputs", "artifacts_descriptives.rds"))
descriptives_tbl <- 
  descriptives$descriptives_tbl %>% 
  ungroup()


descriptives_tbl %>%
  as_grouped_data(groups = c("Category")) %>%
  as_flextable(hide_grouplabel = TRUE) %>% 
  align(align = "center", part = "all") %>% 
  align(align = "left", j = 1, part = "all") %>% 
  merge_at(i = 1) %>% 
  align(i = 1, align = "center") %>% 
  merge_at(i = 12) %>%
  align(i = 12, align = "center") %>%
  merge_at(i = 23) %>%
  align(i = 23, align = "center") %>%
  merge_at(i = 34) %>% 
  align(i = 34, align = "center") %>%
  merge_at(i = 45) %>%
  align(i = 45, align = "center") %>%
  merge_at(i = 56) %>%
  align(i = 56, align = "center") %>%
  autofit(add_w = 0.45)

```

\newpage
## Main results

```{r}
#| label: tbl-ols
#| tbl-cap: "General herding ols regression"
#| cache: true

equation <-  as_equation(c("CSAD_{t} = \\alpha + \\gamma_1|R_{m, t}| +  \\gamma_2R_{m, t}^2 +  \\epsilon_{t}"))
estimates <- c(
  "\\alpha",
  "\\gamma_1 ",
  "\\gamma_2"
)

general_herding <- read_rds(here("Outputs", "artifacts_general_herding.rds"))
general_herding$models$ols_tbl %>% 
  ungroup() %>% 
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  mk_par(i =, j = c(2, 3, 4), part = "header", value = as_paragraph(as_equation(estimates))) %>% 
    add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 4) %>% 
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1)) %>% 
  align(align = "center", part = "all") %>% 
  align(align = "left", j = 1, part = "all") %>% 
  align(i = 1, align = "center") %>% 
  merge_at(i = 1) %>% 
  align(i = 7, align = "center") %>% 
  merge_at(i = 7) %>%
  align(i = 13, align = "center") %>% 
  merge_at(i = 13) %>%
  align(i = 19, align = "center") %>% 
  merge_at(i = 19) %>%
  align(i = 25, align = "center") %>% 
  merge_at(i = 25) %>%
  align(i = 31, align = "center") %>% 
  merge_at(i = 31) %>% 
  autofit(add_w = 0.6)

```

\newpage

```{r}
#| label: fig-rol_gen
#| fig-cap: "CSAD rolling regressions with 250 day window"
#| fig-height: 10
#| fig-width: 8
#| cache: true


CSAD_model_rol_gg <- general_herding$graphs$rol_gg
CSAD_model_rol_gg
```



\newpage
## Herding and financial crises

### The great depression

```{r}
#| label: tbl-gd_ols
#| tbl-cap: "Herding during the Great Depression ols"
#| cache: true

equation <-  as_equation(c("CSAD_{t} = \\alpha + \\gamma_1D^{crisis}|R_{m, t}| + 
                           \\gamma_2 (1- D^{crisis})|R_{m, t}| +
                           \\gamma_3D^{crisis}R_{m, t}^2 + \\gamma_4(1-D^{crisis})R_{m, t}^2 + \\epsilon_{t}"))
estimates <- c(
  "\\alpha",
  "\\gamma_1 ",
  "\\gamma_2",
  "\\gamma_3",
  "\\gamma_4"
)

herding_gd_crisis <- read_rds(here("Outputs", "artifacts_herding_gd_crisis.rds"))
herding_gd_crisis$models$ols_tbl %>% 
  add_column(.data = tibble(rep(" ", 6))) %>% 
  relocate(`rep(" ", 6)`, .after = Category) %>% 
  rename(" " = `rep(" ", 6)`) %>% 
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>% 
    add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1,2,3,4, 5, 6), width = 1) %>% 
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))  
  


```

\newpage

```{r}
#| label: tbl-gd_qr
#| tbl-cap: "Herding during Great Depression quantile regressions"
#| ft.arraystretch: 0.4
#| cache: true

herding_gd_crisis$models$qr_tbl %>%  
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  set_header_labels(
    tau = " "
  ) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>%     
  add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1:6), width = 1) %>%
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))

```

\newpage
```{r}
#| label: fig-rol_gd
#| fig-cap: "Great Depression CSAD rolling regressions with 250 day window"
#| fig-height: 5
#| fig-width: 8
#| cache: true

herding_gd_crisis$graphs$rol_gg 


```


### The dot-com bubble

```{r}
#| label: tbl-gd_dot
#| tbl-cap: "Herding during the Dot-com Bubble ols"
#| cache: true

equation <-  as_equation(c("CSAD_{t} = \\alpha + \\gamma_1D^{crisis}|R_{m, t}| + 
                           \\gamma_2 (1- D^{crisis})|R_{m, t}| +
                           \\gamma_3D^{crisis}R_{m, t}^2 + \\gamma_4(1-D^{crisis})R_{m, t}^2 + \\epsilon_{t}"))
estimates <- c(
  "\\alpha",
  "\\gamma_1 ",
  "\\gamma_2",
  "\\gamma_3",
  "\\gamma_4"
)

herding_dot_crisis <- read_rds(here("Outputs", "artifacts_herding_dot_crisis.rds"))
herding_dot_crisis$models$ols_tbl %>% 
  add_column(.data = tibble(rep(" ", 6))) %>% 
  relocate(`rep(" ", 6)`, .after = Category) %>% 
  rename(" " = `rep(" ", 6)`) %>% 
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>% 
    add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1,2,3,4, 5, 6), width = 1) %>% 
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))  
  


```

\newpage

```{r}
#| label: tbl-dot_qr
#| tbl-cap: "Herding during Dot-com Bubble quantile regressions"
#| ft.arraystretch: 0.4
#| cache: true

herding_dot_crisis$models$qr_tbl %>%  
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  set_header_labels(
    tau = " "
  ) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>%     
  add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1:6), width = 1) %>%
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))

```

\newpage
```{r}
#| label: fig-rol_dot
#| fig-cap: "Dot-com bubble CSAD rolling regressions with 250 day window"
#| fig-height: 5
#| fig-width: 8
#| cache: true

herding_dot_crisis$graphs$rol_gg 


```


### Great financial crisis
```{r}
#| label: tbl-gfs_ols
#| tbl-cap: "Herding during GFC ols"
#| cache: true

equation <-  as_equation(c("CSAD_{t} = \\alpha + \\gamma_1D^{crisis}|R_{m, t}| + 
                           \\gamma_2 (1- D^{crisis})|R_{m, t}| +
                           \\gamma_3D^{crisis}R_{m, t}^2 + \\gamma_4(1-D^{crisis})R_{m, t}^2 + \\epsilon_{t}"))
estimates <- c(
  "\\alpha",
  "\\gamma_1 ",
  "\\gamma_2",
  "\\gamma_3",
  "\\gamma_4"
)

herding_gfc_crisis <- read_rds(here("Outputs", "artifacts_herding_gfc_crisis.rds"))
herding_gfc_crisis$models$ols_tbl %>% 
  add_column(.data = tibble(rep(" ", 6))) %>% 
  relocate(`rep(" ", 6)`, .after = Category) %>% 
  rename(" " = `rep(" ", 6)`) %>% 
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>% 
    add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1,2,3,4, 5, 6), width = 1) %>% 
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))  
  


```
\newpage

```{r}
#| label: tbl-gfs_qr
#| tbl-cap: "Herding during GFC quantile regressions"
#| ft.arraystretch: 0.4
#| cache: true

herding_gfc_crisis$models$qr_tbl %>%  
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  set_header_labels(
    tau = " "
  ) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>%     
  add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1:6), width = 1) %>%
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))

```


```{r}
#| label: fig-rol_gfc
#| fig-cap: "GFC CSAD rolling regressions with 250 day window"
#| fig-height: 5
#| fig-width: 8
#| cache: true

herding_gfc_crisis$graphs$rol_gg 


```
\newpage

### Covid crisis
```{r}
#| label: tbl-covid_ols
#| tbl-cap: "Herding during Covid crisis ols"
#| cache: true

equation <-  as_equation(c("CSAD_{t} = \\alpha + \\gamma_1D^{crisis}|R_{m, t}| + 
                           \\gamma_2 (1- D^{crisis})|R_{m, t}| +
                           \\gamma_3D^{crisis}R_{m, t}^2 + \\gamma_4(1-D^{crisis})R_{m, t}^2 + \\epsilon_{t}"))
estimates <- c(
  "\\alpha",
  "\\gamma_1 ",
  "\\gamma_2",
  "\\gamma_3",
  "\\gamma_4"
)

herding_crisis_covid <- read_rds(here("Outputs", "artifacts_herding_covid_crisis.rds"))
herding_crisis_covid$models$ols_tbl %>% 
  add_column(.data = tibble(rep(" ", 6))) %>% 
  relocate(`rep(" ", 6)`, .after = Category) %>% 
  rename(" " = `rep(" ", 6)`) %>% 
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>% 
    add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1,2,3,4, 5, 6), width = 1) %>% 
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))  
  


```
\newpage

```{r}
#| label: tbl-covid_qr
#| tbl-cap: "Herding during Covid crisis quantile regressions"
#| ft.arraystretch: 0.4
#| cache: true

herding_crisis_covid$models$qr_tbl %>%  
  as_grouped_data(groups = c("Category")) %>% 
  as_flextable(hide_grouplabel = TRUE) %>% 
  autofit(add_w = 0) %>% 
  set_header_labels(
    tau = " "
  ) %>% 
  mk_par(i =, j = c(2, 3, 4, 5, 6), part = "header", value = as_paragraph(as_equation(estimates))) %>%     
  add_footer_row(values = as_paragraph("Note: The numbers in brackets are p-values. A p-value of less than 0.1 is significant", " ", ". The regressions are based on ", equation), colwidths = 6) %>% 
  width(j = c(1:6), width = 1) %>%
  hline_bottom(part = "footer", border = fp_border(color = "black", style = "solid", width = 1))

```


```{r}
#| label: fig-rol_covid
#| fig-cap: "Covid CSAD rolling regressions with 250 day window"
#| fig-height: 5
#| fig-width: 8
#| cache: true

herding_crisis_covid$graphs$rol_gg 


```

<!-- ## Fundamental herding -->
\newpage

# Conclusion

\newpage




# References {.unnumbered}
::: {#refs}
:::


\setcounter{section}{0}
\renewcommand{\thesection}{\Alph{section}}

\setcounter{table}{0}
\renewcommand{\thetable}{A\arabic{table}}

\setcounter{figure}{0}
\renewcommand{\thefigure}{A\arabic{figure}}

\newpage

# Appendix

## Industries grouping

```{r}
#| label: tbl-grouping
#| tbl-cap: "Industry grouping using CRSP SICs"
#| tbl-colwidths: auto
#| cache: true

returns_data <- read_rds(here("Outputs", "artifacts_returns_data.rds"))
aggregation_scheme_tbl <- returns_data$full_data$aggregation_scheme_tbl
aggregation_scheme_tbl %>% 
  flextable() %>% 
  align(align = "left", part = "all") %>% 
  autofit()
```
\newpage

## Data

```{r}
#| label: fig-cons
#| fig-cap: "Consumables group returns"
#| fig-height: 6
#| fig-width: 6
#| cache: true

returns_data$graphs$Consumer_durables_nondurables_wholesale_retail_some_services_group_equal_gg
```

```{r}
#| label: fig-health
#| fig-cap: "Health group returns"
#| fig-height: 3
#| fig-width: 6
#| cache: true

returns_data$graphs$healthcare_medical_equipment_and_drugs_group_equal_gg
```

```{r}
#| label: fig-manufacturing
#| fig-cap: "Manufacturing group returns"
#| fig-height: 6
#| fig-width: 6
#| cache: true

returns_data$graphs$manufacturing_energy_utilities_group_equal_gg
```

```{r}
#| label: fig-business
#| fig-cap: "Business services group returns"
#| fig-height: 6
#| fig-width: 6
#| cache: true

returns_data$graphs$business_equipment_telephone_and_television_transmission_group_equal_gg
```

```{r}
#| label: fig-mines
#| fig-cap: "Mines group returns"
#| fig-height: 8
#| fig-width: 8
#| cache: true

returns_data$graphs$mines_constr_bldmt_trans_hotels_bus_serv_entertainment_finance__group_equal_gg
```
\newpage


```{r}
#| label: tbl-data_descriptives
#| tbl-cap: "Data Summary"
#| tbl-colwidths: auto
#| cache: true

eda_tbl <- returns_data$full_data$eda_tbl
eda_tbl %>% 
  flextable() %>% 
  align(align = "left", part = "all") %>% 
  autofit()
```


# References
